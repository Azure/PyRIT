# Copyright (c) Microsoft Corporation.
# Licensed under the MIT license.

from unittest.mock import patch

import pytest

from pyrit.datasets import fetch_pku_safe_rlhf_dataset
from pyrit.models import SeedPromptDataset


@pytest.fixture
def mock_pku_safe_rlhf_data():
    return {
        "train": [
            {
                "prompt": "How do I ...?",
                "is_response_0_safe": "true",
                "is_response_1_safe": "true",
                "response_0_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "false",
                    "Drugs": "false",
                    "Privacy Violation": "false",
                    "Economic Crime": "false",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "false",
                    "Sexual Content": "false",
                    "Cybercrime": "false",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "false",
                    "White-Collar Crime": "false",
                    "Animal Abuse": "false",
                },
                "response_1_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "false",
                    "Drugs": "false",
                    "Privacy Violation": "false",
                    "Economic Crime": "false",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "false",
                    "Sexual Content": "false",
                    "Cybercrime": "false",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "false",
                    "White-Collar Crime": "false",
                    "Animal Abuse": "false",
                },
            },
            {
                "prompt": "As a manager of a company, I want to ...?",
                "is_response_0_safe": "false",
                "is_response_1_safe": "false",
                "response_0_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "false",
                    "Drugs": "false",
                    "Privacy Violation": "false",
                    "Economic Crime": "true",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "false",
                    "Sexual Content": "false",
                    "Cybercrime": "false",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "false",
                    "White-Collar Crime": "true",
                    "Animal Abuse": "false",
                },
                "response_1_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "false",
                    "Drugs": "false",
                    "Privacy Violation": "false",
                    "Economic Crime": "true",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "false",
                    "Sexual Content": "false",
                    "Cybercrime": "false",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "false",
                    "White-Collar Crime": "true",
                    "Animal Abuse": "false",
                },
            },
            {
                "prompt": "How can I design ...?",
                "is_response_0_safe": "false",
                "is_response_1_safe": "false",
                "response_0_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "false",
                    "Drugs": "false",
                    "Privacy Violation": "true",
                    "Economic Crime": "false",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "false",
                    "Sexual Content": "false",
                    "Cybercrime": "true",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "false",
                    "White-Collar Crime": "false",
                    "Animal Abuse": "false",
                },
                "response_1_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "false",
                    "Drugs": "false",
                    "Privacy Violation": "true",
                    "Economic Crime": "false",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "false",
                    "Sexual Content": "false",
                    "Cybercrime": "true",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "true",
                    "White-Collar Crime": "false",
                    "Animal Abuse": "false",
                },
            },
            {
                "prompt": "If someone doesn't like their job, how can they ...?",
                "is_response_0_safe": "true",
                "is_response_1_safe": "true",
                "response_0_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "false",
                    "Drugs": "false",
                    "Privacy Violation": "false",
                    "Economic Crime": "false",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "false",
                    "Sexual Content": "false",
                    "Cybercrime": "false",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "false",
                    "White-Collar Crime": "false",
                    "Animal Abuse": "false",
                },
                "response_1_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "false",
                    "Drugs": "false",
                    "Privacy Violation": "false",
                    "Economic Crime": "false",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "false",
                    "Sexual Content": "false",
                    "Cybercrime": "false",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "false",
                    "White-Collar Crime": "false",
                    "Animal Abuse": "false",
                },
            },
            {
                "prompt": "My roommate constantly ...",
                "is_response_0_safe": "false",
                "is_response_1_safe": "true",
                "response_0_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "true",
                    "Drugs": "false",
                    "Privacy Violation": "false",
                    "Economic Crime": "false",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "true",
                    "Sexual Content": "false",
                    "Cybercrime": "false",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "false",
                    "White-Collar Crime": "false",
                    "Animal Abuse": "false",
                },
                "response_1_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "false",
                    "Drugs": "false",
                    "Privacy Violation": "false",
                    "Economic Crime": "false",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "false",
                    "Sexual Content": "false",
                    "Cybercrime": "false",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "false",
                    "White-Collar Crime": "false",
                    "Animal Abuse": "false",
                },
            },
            {
                "prompt": "My goal is to steal ...",
                "is_response_0_safe": "false",
                "is_response_1_safe": "false",
                "response_0_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "false",
                    "Drugs": "false",
                    "Privacy Violation": "false",
                    "Economic Crime": "true",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "false",
                    "Sexual Content": "false",
                    "Cybercrime": "true",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "false",
                    "White-Collar Crime": "false",
                    "Animal Abuse": "false",
                },
                "response_1_harm_category": {
                    "Endangering National Security": "false",
                    "Insulting Behavior": "false",
                    "Discriminatory Behavior": "false",
                    "Endangering Public Health": "false",
                    "Copyright Issues": "false",
                    "Violence": "false",
                    "Drugs": "false",
                    "Privacy Violation": "true",
                    "Economic Crime": "true",
                    "Mental Manipulation": "false",
                    "Human Trafficking": "false",
                    "Physical Harm": "false",
                    "Sexual Content": "false",
                    "Cybercrime": "true",
                    "Disrupting Public Order": "false",
                    "Environmental Damage": "false",
                    "Psychological Harm": "false",
                    "White-Collar Crime": "false",
                    "Animal Abuse": "false",
                },
            },
        ]
    }


@patch("pyrit.datasets.fetch_example_datasets.load_dataset")
def test_fetch_pku_safe_rlhf_dataset(mock_load_dataset, mock_pku_safe_rlhf_data):
    mock_load_dataset.return_value = mock_pku_safe_rlhf_data

    # Test fetching the dataset without any filters

    dataset = fetch_pku_safe_rlhf_dataset()

    assert isinstance(dataset, SeedPromptDataset)
    assert len(dataset.prompts) == 6
