import { useState, KeyboardEvent, useRef } from 'react'
import {
  makeStyles,
  Textarea,
  Button,
  tokens,
  Caption1,
} from '@fluentui/react-components'
import { SendRegular, AttachRegular, DismissRegular } from '@fluentui/react-icons'
import { MessageAttachment } from '../../types'

const useStyles = makeStyles({
  root: {
    padding: tokens.spacingVerticalXL,
    borderTop: `1px solid ${tokens.colorNeutralStroke1}`,
    backgroundColor: tokens.colorNeutralBackground1,
  },
  inputContainer: {
    display: 'flex',
    flexDirection: 'column',
    gap: tokens.spacingHorizontalM,
    maxWidth: '1200px',
    margin: '0 auto',
  },
  attachmentsContainer: {
    display: 'flex',
    flexWrap: 'wrap',
    gap: tokens.spacingHorizontalS,
  },
  attachmentChip: {
    display: 'flex',
    alignItems: 'center',
    gap: tokens.spacingHorizontalXS,
    padding: `${tokens.spacingVerticalXXS} ${tokens.spacingHorizontalS}`,
    backgroundColor: tokens.colorNeutralBackground3,
    borderRadius: tokens.borderRadiusMedium,
    border: `1px solid ${tokens.colorNeutralStroke1}`,
  },
  inputRow: {
    display: 'flex',
    gap: tokens.spacingHorizontalM,
  },
  textarea: {
    flex: 1,
  },
  buttonGroup: {
    display: 'flex',
    flexDirection: 'column',
    gap: tokens.spacingVerticalS,
  },
  sendButton: {
    alignSelf: 'flex-end',
  },
})

interface InputBoxProps {
  onSend: (message: string, attachments: MessageAttachment[]) => void
  disabled?: boolean
}

export default function InputBox({ onSend, disabled = false }: InputBoxProps) {
  const styles = useStyles()
  const [input, setInput] = useState('')
  const [attachments, setAttachments] = useState<MessageAttachment[]>([])
  const fileInputRef = useRef<HTMLInputElement>(null)

  const handleFileSelect = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files
    if (!files) return

    const newAttachments: MessageAttachment[] = []
    
    for (let i = 0; i < files.length; i++) {
      const file = files[i]
      const url = URL.createObjectURL(file)
      
      let type: MessageAttachment['type'] = 'file'
      if (file.type.startsWith('image/')) type = 'image'
      else if (file.type.startsWith('audio/')) type = 'audio'
      else if (file.type.startsWith('video/')) type = 'video'
      
      newAttachments.push({
        type,
        name: file.name,
        url,
        mimeType: file.type,
        size: file.size,
        file,  // Store the actual File object
      })
    }
    
    setAttachments([...attachments, ...newAttachments])
    if (fileInputRef.current) {
      fileInputRef.current.value = ''
    }
  }

  const removeAttachment = (index: number) => {
    const newAttachments = [...attachments]
    URL.revokeObjectURL(newAttachments[index].url)
    newAttachments.splice(index, 1)
    setAttachments(newAttachments)
  }

  const handleSend = () => {
    if ((input.trim() || attachments.length > 0) && !disabled) {
      onSend(input.trim(), attachments)
      setInput('')
      // Don't revoke URLs - they're needed for display in the message list
      // The browser will clean them up automatically when the page unloads
      setAttachments([])
    }
  }

  const handleKeyDown = (e: KeyboardEvent<HTMLTextAreaElement>) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault()
      handleSend()
    }
  }

  const formatFileSize = (bytes: number) => {
    if (bytes < 1024) return bytes + ' B'
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB'
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB'
  }

  return (
    <div className={styles.root}>
      <div className={styles.inputContainer}>
        {attachments.length > 0 && (
          <div className={styles.attachmentsContainer}>
            {attachments.map((att, index) => (
              <div key={index} className={styles.attachmentChip}>
                <Caption1>
                  {att.type === 'image' && 'ğŸ–¼ï¸'}
                  {att.type === 'audio' && 'ğŸµ'}
                  {att.type === 'video' && 'ğŸ¥'}
                  {att.type === 'file' && 'ğŸ“„'}
                  {' '}{att.name} ({formatFileSize(att.size)})
                </Caption1>
                <Button
                  appearance="transparent"
                  size="small"
                  icon={<DismissRegular />}
                  onClick={() => removeAttachment(index)}
                />
              </div>
            ))}
          </div>
        )}
        <div className={styles.inputRow}>
          <Textarea
            className={styles.textarea}
            placeholder="Type your message... (Shift+Enter for new line)"
            value={input}
            onChange={(_, data) => setInput(data.value)}
            onKeyDown={handleKeyDown}
            disabled={disabled}
            resize="vertical"
            rows={3}
          />
          <div className={styles.buttonGroup}>
            <input
              ref={fileInputRef}
              type="file"
              multiple
              accept="image/*,audio/*,video/*,.pdf,.doc,.docx,.txt"
              style={{ display: 'none' }}
              onChange={handleFileSelect}
            />
            <Button
              appearance="subtle"
              icon={<AttachRegular />}
              onClick={() => fileInputRef.current?.click()}
              disabled={disabled}
              title="Attach files"
            />
            <Button
              className={styles.sendButton}
              appearance="primary"
              icon={<SendRegular />}
              onClick={handleSend}
              disabled={disabled || (!input.trim() && attachments.length === 0)}
            >
              {disabled ? 'Sending...' : 'Send'}
            </Button>
          </div>
        </div>
      </div>
    </div>
  )
}
