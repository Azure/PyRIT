name: Build and Push Docker Image to ACR

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      tag:
        description: 'Custom tag for the image (optional)'
        required: false
        type: string

env:
  IMAGE_NAME: pyrit

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to Azure
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Get ACR login server
        id: acr-info
        run: |
          ACR_NAME="${{ secrets.AZURE_CONTAINER_REGISTRY_NAME }}"
          LOGIN_SERVER=$(az acr show --name $ACR_NAME --query loginServer --output tsv)
          echo "login-server=$LOGIN_SERVER" >> $GITHUB_OUTPUT

      - name: Build metadata
        id: meta
        run: |
          COMMIT_HASH=$(git rev-parse --short HEAD)
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          
          # Sanitize branch name for Docker tag
          BRANCH_TAG=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g')
          
          echo "commit-hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "branch-tag=$BRANCH_TAG" >> $GITHUB_OUTPUT
          
          # Build tags list
          TAGS="${{ env.IMAGE_NAME }}:$COMMIT_HASH"
          TAGS="$TAGS ${{ env.IMAGE_NAME }}:$BRANCH_TAG-latest"
          
          # Add 'latest' tag only for main branch
          if [ "$BRANCH_NAME" = "main" ]; then
            TAGS="$TAGS ${{ env.IMAGE_NAME }}:latest"
          fi
          
          # Add custom tag if provided
          if [ -n "${{ github.event.inputs.tag }}" ]; then
            TAGS="$TAGS ${{ env.IMAGE_NAME }}:${{ github.event.inputs.tag }}"
          fi
          
          echo "tags=$TAGS" >> $GITHUB_OUTPUT

      - name: Build and push to ACR
        run: |
          ACR_NAME="${{ secrets.AZURE_CONTAINER_REGISTRY_NAME }}"
          
          # Build --image arguments for each tag
          IMAGE_ARGS=""
          for TAG in ${{ steps.meta.outputs.tags }}; do
            IMAGE_ARGS="$IMAGE_ARGS --image $TAG"
          done
          
          az acr build \
            --registry $ACR_NAME \
            $IMAGE_ARGS \
            --file docker/Dockerfile \
            --build-arg PYRIT_SOURCE=local \
            --platform linux/amd64 \
            .

      - name: Summary
        run: |
          echo "## ðŸ³ Docker Image Built and Pushed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Registry:** ${{ steps.acr-info.outputs.login-server }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          for TAG in ${{ steps.meta.outputs.tags }}; do
            echo "- \`${{ steps.acr-info.outputs.login-server }}/$TAG\`" >> $GITHUB_STEP_SUMMARY
          done
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Pull command:**" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "az acr login --name ${{ secrets.AZURE_CONTAINER_REGISTRY_NAME }}" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ steps.acr-info.outputs.login-server }}/${{ env.IMAGE_NAME }}:${{ steps.meta.outputs.commit-hash }}" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
