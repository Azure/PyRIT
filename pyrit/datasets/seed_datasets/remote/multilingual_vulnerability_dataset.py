# Copyright (c) Microsoft Corporation.
# Licensed under the MIT license.

import logging
from pathlib import Path
from typing import Optional

import pandas as pd

from pyrit.datasets.seed_datasets.remote.remote_dataset_loader import RemoteDatasetLoader
from pyrit.models import SeedDataset, SeedPrompt

logger = logging.getLogger(__name__)


class MultilingualVulnerabilityDataset(RemoteDatasetLoader):
    """
    Loader for the Multilingual Vulnerability dataset.

    This dataset contains multilingual prompts demonstrating LLM vulnerabilities,
    labeled by type. From "A Framework to Assess Multilingual Vulnerabilities of LLMs".

    Reference: https://arxiv.org/pdf/2503.13081
    GitHub: https://github.com/CarsonDon/Multilingual-Vuln-LLMs
    """

    def __init__(
        self,
        *,
        source: str = "https://raw.githubusercontent.com/CarsonDon/Multilingual-Vuln-LLMs/main/prompts/allprompt.csv",
        cache: bool = True,
        data_home: Optional[Path] = None,
    ):
        """
        Initialize the Multilingual Vulnerability dataset loader.

        Args:
            source: URL to the CSV file. Defaults to the official repository.
            cache: Whether to cache the fetched examples. Defaults to True.
            data_home: Directory to store cached data. Defaults to None.
        """
        self.source = source
        self.cache = cache
        self.data_home = data_home

    @property
    def dataset_name(self) -> str:
        return "multilingual_vulnerability"

    async def fetch_dataset(self) -> SeedDataset:
        """
        Fetch Multilingual Vulnerability dataset and return as SeedDataset.

        Returns:
            SeedDataset: A SeedDataset containing the multilingual vulnerability prompts.
        """
        logger.info(f"Loading Multilingual Vulnerability dataset from {self.source}")

        # Use pandas to read the CSV directly from URL
        df = pd.read_csv(self.source)

        seed_prompts = [
            SeedPrompt(
                value=row["en"],
                data_type="text",
                name=self.dataset_name,
                dataset_name=self.dataset_name,
                harm_categories=[row["type"]],
                description=(
                    "Dataset from 'A Framework to Assess Multilingual Vulnerabilities of LLMs'. "
                    "Multilingual prompts demonstrating LLM vulnerabilities, labeled by type. "
                    "Paper: https://arxiv.org/pdf/2503.13081"
                ),
                authors=[
                    "Likai Tang",
                    "Niruth Bogahawatta",
                    "Yasod Ginige",
                    "Jiarui Xu",
                    "Shixuan Sun",
                    "Surangika Ranathunga",
                    "Suranga Seneviratne",
                ],
                source="https://github.com/CarsonDon/Multilingual-Vuln-LLMs",
            )
            for _, row in df.iterrows()
        ]

        logger.info(f"Successfully loaded {len(seed_prompts)} prompts from Multilingual Vulnerability dataset")

        return SeedDataset(prompts=seed_prompts)
